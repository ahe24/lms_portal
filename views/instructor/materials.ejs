<%- include('../partials/head') %>
    <%- include('../partials/sidebar') %>

        <div class="page-header flex-between">
            <div>
                <h1>자료 보관함</h1>
                <p>강의에 사용될 PDF 슬라이드를 업로드하고 관리합니다.</p>
            </div>
        </div>

        <!-- Upload form -->
        <div class="card mb-2" style="max-width:600px;">
            <div class="card-header">
                <span class="card-title">📤 PDF 라이브러리에 추가</span>
            </div>

            <div id="uploadAlert" class="alert" style="display:none;"></div>

            <form id="uploadForm" enctype="multipart/form-data">
                <div
                    style="background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; padding: 0.75rem 1rem; margin-bottom: 1.5rem; border-radius: 4px; font-size: 0.875rem; color: var(--text-color);">
                    💡PDF 변환은 페이지 수에 따라 시간이 소요됩니다. 변환 중 다른 페이지로 이동하셔도 백그라운드에서 계속 처리됩니다.
                </div>

                <div class="form-group">
                    <label class="form-label">자료 제목</label>
                    <input type="text" name="title" class="form-input" placeholder="제목을 입력하지 않으면 파일명이 사용됩니다">
                </div>
                <div class="form-group">
                    <label class="form-label">PDF 파일 *</label>
                    <input type="file" name="pdf" accept=".pdf" class="form-input" required>
                    <small class="text-muted text-sm">최대 50MB, PDF 파일만 가능</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_shared" value="1" checked>
                        <span>다른 강사와 공유 (다른 강사가 자신의 강의에 이 자료를 추가할 수 있습니다)</span>
                    </label>
                </div>

                <!-- Progress Bar -->
                <div id="progressContainer" style="display:none; margin-top: 1rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.25rem;">
                        <span id="progressText" class="text-sm font-medium">업로드 중...</span>
                        <span id="progressPercent" class="text-sm font-medium">0%</span>
                    </div>
                    <div style="background-color:var(--border-color); border-radius:99px; height:8px; overflow:hidden;">
                        <div id="progressBar"
                            style="width:0%; height:100%; background-color:var(--primary-color); transition:width 0.2s;">
                        </div>
                    </div>
                </div>

                <button type="submit" id="uploadBtn" class="btn btn-primary mt-1">📤 업로드 및 변환</button>
            </form>
        </div>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            // Initialize Socket.io
            const socket = io();
            let mySocketId = null;

            socket.on('connect', () => {
                mySocketId = socket.id;
                console.log('Connected to socket:', mySocketId);
            });

            // Listen for PDF conversion progress
            socket.on('pdf-progress', (data) => {
                // data: { current, total, percent }
                const pText = document.getElementById('progressText');
                const pBar = document.getElementById('progressBar');
                const pPercent = document.getElementById('progressPercent');

                if (pText && pBar && pPercent) {
                    pText.innerText = `PDF 변환 중... (${data.current}/${data.total} 페이지)`;
                    pBar.style.width = data.percent + '%';
                    pBar.style.backgroundColor = '#f59e0b'; // Amber for processing
                    pPercent.innerText = `${data.percent}%`;
                }
            });

            let isUploading = false;

            // Warn user before leaving page during upload
            window.addEventListener('beforeunload', (e) => {
                if (isUploading) {
                    e.preventDefault();
                    e.returnValue = '파일 업로드 및 변환이 진행 중입니다. 페이지를 나가시겠습니까?';
                    return e.returnValue;
                }
            });

            document.getElementById('uploadForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const form = this;
                const formData = new FormData(form);

                // Append socket_id so server knows who to update
                if (mySocketId) {
                    formData.append('socket_id', mySocketId);
                }

                const xhr = new XMLHttpRequest();
                const btn = document.getElementById('uploadBtn');
                const pContainer = document.getElementById('progressContainer');
                const pBar = document.getElementById('progressBar');
                const pText = document.getElementById('progressText');
                const pPercent = document.getElementById('progressPercent');
                const alertBox = document.getElementById('uploadAlert');

                // UI Reset
                alertBox.style.display = 'none';
                alertBox.className = 'alert';
                btn.disabled = true;
                isUploading = true;
                pContainer.style.display = 'block';
                pBar.style.width = '0%';
                pBar.style.backgroundColor = 'var(--primary-color)';
                pPercent.innerText = '0%';
                pText.innerText = '준비 중...';

                xhr.open('POST', '/instructor/materials/upload', true);

                // Upload Progress
                xhr.upload.onprogress = function (e) {
                    let percent = 0;
                    if (e.lengthComputable && e.total > 0) {
                        percent = Math.round((e.loaded / e.total) * 100);
                    } else {
                        percent = 50;
                    }

                    pBar.style.width = percent + '%';
                    pPercent.innerText = percent + '%';

                    if (percent >= 100) {
                        pText.innerText = '업로드 완료! PDF 변환 시작 중... (페이지 수에 따라 시간이 소요될 수 있습니다)';
                        pBar.style.backgroundColor = '#f59e0b'; // Change to amber
                    } else {
                        pText.innerText = '파일 업로드 중...';
                    }
                };

                // Completion
                xhr.onload = function () {
                    isUploading = false;

                    if (xhr.status >= 200 && xhr.status < 400) {
                        // Success
                        pBar.style.width = '100%';
                        pBar.style.backgroundColor = '#22c55e';
                        pText.innerText = '변환 완료! 페이지를 새로고침합니다...';
                        pPercent.innerText = '100%';

                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        btn.disabled = false;
                        pContainer.style.display = 'none';
                        alertBox.className = 'alert alert-error';
                        alertBox.innerText = '업로드 실패: ' + (xhr.responseText || '서버 오류');
                        alertBox.style.display = 'block';
                    }
                };

                xhr.onerror = function () {
                    isUploading = false;
                    btn.disabled = false;
                    pContainer.style.display = 'none';
                    alertBox.className = 'alert alert-error';
                    alertBox.innerText = '네트워크 오류가 발생했습니다.';
                    alertBox.style.display = 'block';
                };

                xhr.send(formData);
            });
        </script>

        <!-- Materials library list -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">📚 내 자료 목록 (<%= myMaterials.length %>)</span>
            </div>
            <% if (myMaterials.length===0) { %>
                <div class="empty-state">
                    <div class="empty-icon">📄</div>
                    <h3>등록된 자료가 없습니다</h3>
                    <p class="text-muted mt-1">PDF 파일을 업로드하여 라이브러리를 채워보세요</p>
                </div>
                <% } else { %>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>제목</th>
                                    <th>원본 파일명</th>
                                    <th>페이지 수</th>
                                    <th>업로드 일시</th>
                                    <th>공유</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% myMaterials.forEach(m=> { %>
                                    <tr>
                                        <td><strong>
                                                <%= m.title %>
                                            </strong></td>
                                        <td class="text-muted text-sm">
                                            <%= m.original_name %>
                                        </td>
                                        <td>
                                            <%= m.page_count %>p
                                        </td>
                                        <td class="text-muted text-sm">
                                            <%= m.uploaded_at %>
                                        </td>
                                        <td>
                                            <form method="POST" action="/instructor/materials/<%= m.id %>/toggle-share"
                                                style="display:inline;">
                                                <button type="submit"
                                                    class="btn btn-sm <%= m.is_shared ? 'btn-success' : 'btn-outline' %>"
                                                    title="<%= m.is_shared ? '공유 중' : '비공유' %>">
                                                    <%= m.is_shared ? '✓ 공유 중' : '비공유' %>
                                                </button>
                                            </form>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="/materials/<%= m.id %>/view" target="_blank"
                                                    class="btn btn-outline btn-sm">📖 보기</a>
                                                <form method="POST" action="/instructor/materials/<%= m.id %>/delete"
                                                    style="display:inline;"
                                                    onsubmit="return confirm('이 자료를 삭제하시겠습니까? (이 자료를 사용하는 모든 강의에서 제거됩니다)')">
                                                    <button type="submit" class="btn btn-danger btn-sm">🗑️</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <% } %>
        </div>

        <!-- Shared materials from other instructors -->
        <% if (sharedMaterials.length> 0) { %>
            <div class="card mt-2">
                <div class="card-header">
                    <span class="card-title">🤝 다른 강사가 공유한 자료 (<%= sharedMaterials.length %>)</span>
                </div>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>제목</th>
                                <th>원본 파일명</th>
                                <th>페이지 수</th>
                                <th>업로드 일시</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% sharedMaterials.forEach(m=> { %>
                                <tr>
                                    <td>
                                        <strong>
                                            <%= m.title %>
                                        </strong>
                                        <span class="badge badge-info" style="margin-left: 0.5rem;">
                                            <%= m.creator_login %>
                                        </span>
                                    </td>
                                    <td class="text-muted text-sm">
                                        <%= m.original_name %>
                                    </td>
                                    <td>
                                        <%= m.page_count %>p
                                    </td>
                                    <td class="text-muted text-sm">
                                        <%= m.uploaded_at %>
                                    </td>
                                    <td>
                                        <a href="/materials/<%= m.id %>/view" target="_blank"
                                            class="btn btn-outline btn-sm">📖 보기</a>
                                    </td>
                                </tr>
                                <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
            <% } %>

                <%- include('../partials/footer') %>